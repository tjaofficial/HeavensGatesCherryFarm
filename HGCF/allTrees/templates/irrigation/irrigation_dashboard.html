{% extends "mainLayout.html" %}
{% block list %}{% load static %}
<style>
    h1 {
      text-align: center;
      color: #ff8800;
      margin-bottom: 30px;
    }

    .valve-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .valve-card {
      background: #2c2c2c;
      border: 2px solid #7b380b;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 5px #000;
      text-align: center;
    }

    .valve-card h2 {
      margin-bottom: 10px;
      color: #ff8800;
    }

    .status {
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .status.on {
      color: #0f0;
    }

    .status.off {
      color: #aaa;
    }

    .status.error {
      color: red;
    }

    .toggle-btn {
      padding: 10px;
      width: 100%;
      background-color: #7b380b;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
    }

    .toggle-btn:hover {
      background-color: #ff8800;
    }


    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
    }

    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
      padding: 1rem;
    }

    .card h2 {
      margin-bottom: 0.75rem;
      font-size: 1.25rem;
    }

    .schedule-card a {
      text-decoration: none;
      color: #007bff;
      font-weight: bold;
    }

    .valve-manual button {
      margin: 0.25rem;
      padding: 0.75rem 1.25rem;
      border: none;
      background: #4caf50;
      color: white;
      border-radius: 0.5rem;
      cursor: pointer;
    }

    .valve-manual button.off {
      background: #f44336;
    }

    .zone-table {
      width: 100%;
      border-collapse: collapse;
    }

    .zone-table th, .zone-table td {
      padding: 0.5rem;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }

    .light {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      display: inline-block;
      margin: 0 5px;
    }

    .green {
      background-color: #4caf50;
    }

    .red {
      background-color: #f44336;
    }

    .emergency-btn {
      position: fixed;
      top: 6rem;
      right: 2rem;
      background-color: red;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      border: 3px solid #fff;
      z-index: 999;
      cursor: pointer;
    }

    .emergency-btn:active {
      transform: scale(0.95);
    }

    @media (max-width: 600px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }
  </style>

<div style="padding: 35px;">
    <h1>Irrigation Control Dashboard</h1>
    <button class="emergency-btn" title="Emergency Shutoff" onclick="emergencyShutdown()"></button>

    <div class="dashboard">
        <div class="card schedule-card">
          <h2>Today's Schedule</h2>
          <p>No scheduled runs yet.</p>
          <a href="{% url 'irrigation_timer' %}">+ Add Schedule</a>
        </div>

        <div id="valve-container" class="card valve-manual">
            <h2>Manual Valve Control</h2>
            {% comment %} {% for key, x in valves.items %}
                <div>
                    <button onclick="toggleValve('A', true)">Valve A ON</button>
                    <button class="off" onclick="toggleValve('A', false)">OFF</button>
                </div>
            {% endfor %} {% endcomment %}
            {% comment %} <div>
                <button onclick="toggleValve('B', true)">Valve B ON</button>
                <button class="off" onclick="toggleValve('B', false)">OFF</button>
            </div>
            <div>
                <button onclick="toggleValve('C', true)">Valve C ON</button>
                <button class="off" onclick="toggleValve('C', false)">OFF</button>
            </div>
            <div>
                <button onclick="toggleValve('D', true)">Valve D ON</button>
                <button class="off" onclick="toggleValve('D', false)">OFF</button>
            </div> {% endcomment %}
            <a href="{% url 'add_valve' %}">add valve</a>
        </div>

    <div class="card">
      <h2>Valve Zone Status</h2>
      <table class="zone-table">
        <thead>
          <tr>
            <th>Area</th>
            <th>Row</th>
            <th>Front/Back</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="zone-status-table">
          <!-- JS Populated -->
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Pressure Sensor</h2>
      <p><strong>Current Pressure:</strong> <span id="pressure-readout">0 psi</span></p>
    </div>

  </div>

  <script>
    const zones = [
      { area: 'Area 1', row: 'Row 1', side: 'Front', active: true },
      { area: 'Area 1', row: 'Row 1', side: 'Back', active: false },
      { area: 'Area 2', row: 'Row 3', side: 'Front', active: false },
      { area: 'Area 2', row: 'Row 4', side: 'Back', active: true },
    ];

    function renderZoneStatus() {
      const tbody = document.getElementById('zone-status-table');
      tbody.innerHTML = '';
      zones.forEach((zone) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${zone.area}</td>
          <td>${zone.row}</td>
          <td>${zone.side}</td>
          <td>
            <span class="light ${zone.active ? 'green' : 'red'}"></span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function toggleValve(deviceId, turnOn) {
      console.log(deviceId, turnOn)
      fetch("/toggle-valve/", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({
              device_id: deviceId,
              turn: turnOn ? "on" : "off"
          })
      })
      .then(res => res.json())
      .then(data => {
          if (data.status === "success") {
              console.log("Toggled Valve!");
          } else {
              console.error(data.message);
          }
      });
    }

    function fetchValveStatuses() {
      fetch('/dashboard/irrigation/valve-statuses/')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById("valve-container");
            //container.innerHTML = "";

            Object.entries(data.valves).forEach(([name, valve], index) => {
                console.log("Valve data:", name, valve);
                const card = document.createElement("div");
                //card.classList.add("valve-card");

                const statusClass = valve.status === true ? "on" : (valve.status === false ? "off" : "error");
                const statusText = valve.status === true ? "ON" : (valve.status === false ? "OFF" : "ERROR");

                card.innerHTML = `
                    <button onclick="toggleValve(${valve.area_name}, true)">Area ${valve.area_name} ON</button>
                    <button class="off" onclick="toggleValve(${valve.area_name}, false)">OFF</button>
                `;
                 //   <h2>${valve.name}</h2>
                  //  <div class="status ${statusClass}">${statusText}</div>
                  //  <button class="toggle-btn" onclick="toggleValve('${valve.ip}', ${valve.status === true ? false : true})">
                 //       Turn ${valve.status === true ? 'OFF' : 'ON'}
                 //   </button>
                
                
                container.appendChild(card);
            });
            const submit = `<a href="{% url 'add_valve' %}">add valve</a>`;
            container.appendChild(submit);
        });
    }


    // Initial load + refresh every 5 seconds
    fetchValveStatuses();
    //setInterval(fetchValveStatuses, 2000);

    function emergencyShutdown() {
      alert('Emergency shutoff activated! All valves turning off.');
      // Actual shutdown logic goes here
    }

    renderZoneStatus();

    // Simulate pressure sensor
    setInterval(() => {
      const pressure = (Math.random() * 30 + 10).toFixed(2);
      document.getElementById('pressure-readout').textContent = `${pressure} psi`;
    }, 3000);
  </script>
</div>
<div style="padding-top: 89px;">
    
    {% comment %} <div class="valve-grid" id="valve-container"></div>
    <button onclick="shutOffAll()" style="background-color:red; color:white; font-weight:bold; width:100%; padding:15px; margin-bottom:20px; border:none; border-radius:6px;">ðŸš¨ Emergency: Shut Off All Valves</button> {% endcomment %}

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function shutOffAll() {
            if (confirm("Are you sure you want to shut off all valves?")) {
                fetch('/dashboard/emergency-shutoff/')
                .then(() => fetchValveStatuses());
            }
        }
        function fetchSchedule() {
            fetch('/dashboard/schedules/')
                .then(res => res.json())
                .then(data => {
                const list = document.getElementById("schedule-list");
                list.innerHTML = "";
                data.schedules.forEach(s => {
                    const li = document.createElement("li");
                    li.innerText = `${s.valve}: ${s.start} â€“ ${s.end} (${s.days.toUpperCase()})`;
                    list.appendChild(li);
                });
                });
        }

        fetchSchedule();

        
    </script>
</div>
{% endblock %}